{% extends "templates/layout.html" %}

{% block body %}
<div class=" shadow p-5 m-4">
    <h1 class="text-xl font-semibold text-gray-800">{{ _('Checking payment status') }}</h1>
    <p>{{ _('Please do not refresh') }}...</p>
</div>

<script defer>
    const urlParams = new URLSearchParams(window.location.search);
    let payment_mode = urlParams.get('payment_mode');
    const payment_id = urlParams.get('payment_id');
    let reference_id = urlParams.get('reference_id');
    if (!payment_mode) {
        payment_mode = 'tabby'
    }
    if(!reference_id){
        reference_id = payment_id
    }
    frappe_call(
        "/api/v2/method/ls_shop.api.payments.confirm_payment",
        { payment_mode, reference_id }
    ).then(({ data }) => {
        // TODO: handle errors, unpaid, etc.
        if (data.status === "Paid" || data.status === "CLOSED") {
            Alpine.store("cart").remove_selected();
            window.location.href = `/{{frappe.lang}}/account/orders`;
        }
    })
</script>
{% endblock %}