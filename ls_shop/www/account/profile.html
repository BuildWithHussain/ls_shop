{% extends "templates/user_layout.html" %}

{% include "templates/js/form.js.html" %}

{% block user_body %}
<form x-ref="profile_form" 
x-data=
    "{
        errors: [],
    }" 
@submit.prevent="validate_profile($data, $refs)">
    <div class="grid md:grid-cols-2 gap-4 mt-4">
        <div>
            <label for="first_name" class="block text-xs font-normal text-gray-600 mb-3">
                {{ _('First name') }}*
            </label>
            <input type="text" id="first_name" name="first_name"
                class="w-full border-gray-300 rounded-md border p-2 text-sm text-gray-600 focus:outline-hidden focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-black"
                required {% if user_details.first_name %} value="{{user_details.first_name}}" {% endif %}>
        </div>
        <div>
            <label for="last_name" class="block text-xs font-normal text-gray-600 mb-3">
                {{ _('Last name') }}*
            </label>
            <input type="text" id="last_name" name="last_name"
                class="w-full border-gray-300 rounded-md border p-2 text-sm text-gray-600 focus:outline-hidden focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-black"
                required {% if user_details.last_name %} value="{{user_details.last_name}}" {% endif %}>
        </div>
        <div>
            <label for="email" class="block text-xs font-normal text-gray-600 mb-3">
                {{ _('Email') }}*
            </label>
            <input type="email" id="email" name="email"
                class="w-full border-gray-300 rounded-md border p-2 text-sm text-gray-600 focus:outline-hidden focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-black disabled:opacity-75 bg-gray-100"
                required {% if user_details.email %} value="{{user_details.email}}" {% endif %} disabled>
        </div>
        <div>
            <label for="mobile_number" class="block text-xs font-normal text-gray-600 mb-3">
                {{ _('Phone number') }}*
            </label>
            <input type="tel" id="mobile_number" name="mobile_number"
                class="w-full border-gray-300 rounded-md border p-2 text-sm text-gray-600 focus:outline-hidden focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-black"
                required {% if user_details.mobile_no %} value="{{user_details.mobile_no}}" {% endif %}>
        </div>
    </div>
    <div x-show="errors.length > 0"
        class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mt-4" x-cloak
        x-transition.origin.top>
        <ul>
            <template x-for="error in errors" :key="error">
                <li class="text-sm"> <span x-text="$store.i18n.t(error)"></span></li>
            </template>
        </ul>
    </div>
    <button class="bg-red-900 text-white py-2 px-10 mt-4 rounded-lg disabled:opacity-75 flex items-center cursor-pointer"
        x-ref="update_btn">{{_('Update')}}
        <div class="hidden  animate-spin  size-4 border-3 border-current border-t-transparent  rounded-full ms-2"
            role="status" aria-label="loading">
        </div>
    </button>

</form>
<script>
    function validate_profile(state, refs) {
        const data = form_to_object(refs.profile_form);
        state.errors = [];

        if (!data.mobile_number || !/^(\+?\d{1,3}[-.\s]?)?(\(?\d{3}\)?[-.\s]?)?\d{3}[-.\s]?\d{4}$/.test(data.mobile_number)) {
            state.errors.push('Please enter a valid phone number.');
        }

        if (state.errors.length > 0) {
            state.address_loading = false;
            return
        }
        let payload = {
            
            first_name: data.first_name,
            last_name: data.last_name,
            email: data.email,
            mobile_no: data.mobile_number,
        };
        update_profile(payload, refs.update_btn);
    }

    async function update_profile(payload, btn) {
            const user_email = "{{ frappe.session.user }}"; // Get logged-in user email
            const api_url = `/api/v2/document/User/${user_email}`;
            btn.disabled = true;
            const spinner = btn.querySelector(".animate-spin");
            spinner.classList.remove("hidden");
            try {
                const response = await frappe_call(api_url, payload, "PUT");
                const message= $store.i18n.t("Profile updated successfully")
                toast(message, { type: "success" })
                // wait for 400ms before reload
                await new Promise(resolve => setTimeout(resolve, 400));
                window.location.reload()

            }
            catch (error) {
                const message = $store.i18n.t("Something went wrong")
                toast(message, { type: "danger" })
            }
            finally {
                btn.disabled = false;
                const spinner = btn.querySelector(".animate-spin");
                spinner.classList.add("hidden");
            }
        }
</script>

{% endblock %}