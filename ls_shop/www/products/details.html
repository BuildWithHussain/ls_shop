{% extends "templates/layout.html" %}
{% from "templates/macros/item_card.html" import item_card %}
{% from "templates/macros/icon.html" import icon %}
{% from "templates/macros/modal.html" import modal %}
{% from 'templates/macros/tabby-promo.html' import tabby   %}
{% block head %}
<script src="/assets/ls_shop/js/vendor/embla-carousel/core.js"></script>
{% endblock %}
{% block body %}
<style>
    .out-of-stock {
        position: relative;
    }

    .out-of-stock::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0) url("/assets/ls_shop/images/slash.png") no-repeat scroll 50% center / 100% 100% !important;
        pointer-events: none;

    }
    
    .embla__dot--selected {
    background-color: #991b1f !important;
    }
</style>
<!-- Product variant is style attribute variant -->
<!-- Product is the item style template -->
<!-- Selected item is currently selected item -->

<div class=" mx-auto py-8 " x-data='{ 
    product: {{ product_variant.as_json() }}, 
    selected_variant: `{% if size_selected %}{{ json.dumps(selected_item) }}{% endif %}`,
    price:`{{selected_price}}`,
    default_price:`{{default_price}}`,
    brand:`{{product.brand}}`,
    sizes: {{ json.dumps(available_sizes) }},
    size_chart: {% if size_chart %}JSON.parse({{ size_chart|tojson }}){% else %}[]{% endif %},
    qty: 1,
    max_qty: `{{selected_item['stock_detail']['stock_qty']|round|int}}`,
    increment() {
        if (this.qty < this.max_qty) {
        this.qty +=1; 
    }
    else { 
        const message = $store.i18n.t("Only") + " " + this.max_qty + " " + $store.i18n.t("left in stock");
        toast(message, { type: "warning" }); 
        } 
    },
    decrement() { 
        if (this.qty> 1) {
        this.qty -= 1;
        }
    },
    }'>
    <div class="flex flex-col ipad:flex-row md:gap-8">
        <!-- Image Gallery -->
        <div class="flex flex-1 justify-center" x-data="carousel_component()" x-init="init_embla">
            {% include 'templates/components/product_details_carousel.html' %}
        </div>

        <!-- Product Details -->
        <div class="flex flex-2 flex-col pt-6">
            <div class="ipad:max-w-md">

                <a href="/{{frappe.lang}}/products?brands={{product.brand | urlencode}}"
                    class="mb-2 text-xl font-bold md:mb-0 md:text-3xl ">
                    {{ _(product.brand|title) }}
                </a>
                <h2 class="mb-3.5 text-base md:mb-6 md:text-xl ">
                    {% if frappe.lang == "en" %}
                    {{ _(product.item_name|title) }}
                    {% else %}
                    {{ _(product.custom_item_name_ar or product.item_name|title) }}
                    {% endif %}
                </h2>
                <div class="mb-5 flex items-center md:mb-6.5">
                    <!-- Disounted price -->
                    {% if discount_percent %}
                    <span
                        class="text-base font-normal text-red-900 line-through decoration-[1px] md:text-xl flex">{{get_currency_symbol()}}{{"%.2f"|format(default_price)}}</span>
                    {% endif %}
                    <span
                        class="ms-2 text-base font-medium text-gray-900 md:text-xl md:font-medium flex">{{get_currency_symbol()}}{{"%.2f"|format(selected_price)}}</span>
                    <span class="ms-2 mt-0.5 text-xs"> {{_('incl. VAT')}}</span>

                </div>
                <div class="mb-6.5 md:mb-10">
                    {{tabby(price=selected_price or 100)}}
                </div>
                <div class="mb-5">
                    <div class="mb-1 flex items-end justify-between md:mb-3">
                        <h3 class="text-base font-semibold md:text-xl">
                            {{ _('Size') }} : <span class="font-normal">{{_("EU")}} </span>
                        </h3>
                        <template x-if="size_chart.length > 0">
                            <div class="flex items-end">
                                {% call modal(button_text='size chart',button_classes='ms-2 text-base font-medium
                                underline decoration-gray-400 decoration-1 capitalize',
                                modal_header='Size Chart') %}
                                    <div class="p-4">
                                        {% include "templates/components/size_chart_table.html" %}
                                    </div>
                                {% endcall %}
                            </div>
                        </template>
                    </div>
                    {% if size_selected %}
                        <p class="text-red-900 text-xs font-medium mb-3">
                            {% if product_in_stock %}
                            {{_('Only')}}
                            {% endif %}
                            {% if selected_item['stock_detail']['stock_qty'] > 0 %}
                                {{selected_item['stock_detail']['stock_qty']|round|int}}
                            {% else %}
                                0
                            {% endif %}
                            {{_('left in stock')}} 
                        </p>
                    {% endif %}
                    <div class="mt-2 flex flex-wrap gap-3" x-data="{selected_btn:'{{selected_size}}'}">
                        {% for size in available_sizes %}
                            <button
                                class="cursor-pointer text-md rounded-md bg-gray-100 px-4 py-2 font-medium text-gray-700 hover:bg-gray-200 disabled:hover:bg-gray-100 disabled:pointer-events-none"
                                :class="{
                                    'outline outline-red-900 bg-white text-red-900 hover:bg-white': selected_btn==='{{size.size}}'&& '{{size.stock_detail.in_stock}}' === '1' && '{{size_selected}}' !== 'None',
                                    'opacity-50 out-of-stock': '{{size.stock_detail.in_stock}}' !== '1'
                                }"  @click="update_size('{{ size.size }}');
                                selected_variant={{size}}">
                                {{ size.size }}
                            </button>
                        {% endfor %}
                    </div>
                </div>
                {% if not product_in_stock and frappe.session.user != "Guest" %}

                <p class="mt-6 flex items-center text-xs font-medium md:mt-7 w-fit cursor-pointer"
                    @click.debounce.300ms="notify_user_product('{{selected_item.name}}')">
                    Out of stock?
                    {{ icon('notification',classes='h-4 w-4 ms-1') }}
                </p>
                {% endif %}
                {% if product_in_stock and size_selected %}
                <div class="flex justify-between items-center">
                    <h3 class="text-sm font-semibold md:text-xl">
                        {{ _('Quantity') }}
                    </h3>
                    <div class="">
                        <div class="flex items-center gap-1 md:gap-2 border px-1 md:px-2 py-1 w-fit mt-1  rounded-lg border-gray-300 ">
                            <button x-on:click="decrement()" class="cursor-pointer">
                                <img src="/assets/ls_shop/icons/minus.svg" alt="">
                            </button>
                            <span x-text="qty" class="text-sm font-medium"></span>
                            <button x-on:click="increment()" class="cursor-pointer">
                                <img src="/assets/ls_shop/icons/add.svg" alt="">
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}
                <div x-data="{ is_open: false }">
                    <button
                        class="mt-7 flex w-full items-center justify-between rounded-md bg-red-900 px-6 py-3 font-normal text-white opacity-90 hover:opacity-100 focus:ring-2 focus:ring-red-900 focus:outline-none cursor-pointer disabled:opacity-75 disabled:pointer-events-none"
                        @click="
                                    if (selected_variant) {
                                        $store.cart.add(product, selected_variant, price,default_price, brand,sizes,qty);
                                        is_open = true;
                                    } else {
                                        toast('Please select a size first!', {type: 'warning'});
                                    }
                                " {% if not product_in_stock %} disabled {% endif %}>
                        {{ _("Add to shopping bag") }}
                        <span class="ms-2">
                            {{ icon('bag') }}
                        </span>
                    </button>
                    {% call modal(button_classes='hidden',modal_header="Item added to your bag",external_control=True,modal_classes='w-fit') %}
                    <div class="p-6 text-center space-y-4">
                        <div class="flex items-center justify-center">
                            <img src="{{ images[0]}}" alt="{{ _(product_variant.display_name) }}"
                                class="w-34 h-45 object-cover rounded-lg">
                        </div>
                        <p class="text-red-900">
                            {% if frappe.lang == "en" %}
                            {{ _(product.item_name) }}
                            {% else %}
                            {{ _(product.custom_item_name_ar or '') }}
                            {% endif %}
                        </p>

                        <div class="flex justify-center gap-4 mt-6">
                            <button @click="is_open = false"
                                class="px-4 py-2 bg-gray-200  hover:bg-gray-300 rounded-md cursor-pointer">
                                {{ _("Continue Shopping") }}
                            </button>
                            <a href="/{{frappe.lang}}/cart"
                                class="px-4 py-2 bg-red-900 text-white  opacity-90 hover:opacity-100  rounded-md">
                                {{ _("Go to Cart") }}
                            </a>
                        </div>
                    </div>
                    {% endcall %}
                    {% if other_variants %}
                    <div class="pt-6">
                        <h2 class="text-xs font-medium   mb-2 capitalize">
                            {{_("available colors")}}
                        </h2>
                        <div class="grid grid-cols-5   gap-2">
                            {% for color in other_variants %}

                            <div class="flex flex-col items-start">
                                <a href="/{{frappe.lang}}/products/{{color.route}}">
                                    <img src="{{color.image or " /assets/ls_shop/images/1.jpg"}}" alt=""
                                        class="w-18 h-25 object-cover rounded-lg">
                                </a>
                                <p class="text-xs font-medium  text-center mt-1 truncate max-w-15">
                                    {{_(color.attribute_value|title) or ''}}
                                </p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                <!-- Product Details Accordion -->
                <div class="mb-5 border-b border-gray-300 py-7 md:mt-8">
                    <div x-data="{ active_accordion: 'web_long_description' }">
                        <!-- Accordion Item -->
                        <div class="accordion-item">
                            <!-- Accordion Trigger -->
                            <button
                                @click="active_accordion = active_accordion === 'web_long_description' ? null : 'web_long_description'"
                                class="flex w-full items-center justify-between text-xl font-medium"
                                :aria-expanded="active_accordion === 'web_long_description'"
                                aria-controls="content-web_long_description" id="heading-web_long_description ">
                                <span class="capitalize">
                                {{ _("product details") }}
                                </span>
                                <svg xmlns="http://www.w3.org/2000/svg"
                                    class="w-5 h-5 transition-transform duration-200 invert_arrow"
                                    :class="{'rotate-180': active_accordion === 'web_long_description'}"
                                    viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd"
                                        d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 011.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                        clip-rule="evenodd" />
                                </svg>
                            </button>
                            <!-- Accordion Content -->
                            <div x-show="active_accordion === 'web_long_description'"
                                x-transition:enter="transition ease-out duration-200"
                                x-transition:enter-start="opacity-0 transform -translate-y-2"
                                x-transition:enter-end="opacity-100 transform translate-y-0"
                                x-transition:leave="transition ease-in duration-200"
                                x-transition:leave-start="opacity-100 transform translate-y-0"
                                x-transition:leave-end="opacity-0 transform -translate-y-2" class="pt-7 pb-4"
                                id="content-web_long_description" role="region"
                                aria-labelledby="heading-web_long_description">
                                <div>
                                    <ul>
                                        <li>

                                            <span class="text-base font-medium  ">{{_(selected_item.style_code) or ''}}</span>, <span
                                                class="text-base font-medium  ">{{_(product_variant.attribute_value|title)}}</span>
                                        </li>
                                          <li>
                                            <span class="text-base font-medium  ">{{_(product_variant.attribute_name|title
                                                or '')}}</span>
                                        </li>
                                        <li>
                                            <span class="text-base font-medium  ">{{_(selected_item.material|title) or ''}}</span>
                                        </li>

                                    </ul>
                                    {% if selected_item.description != selected_item.item_code %}
                                    {% if frappe.lang == "en" %}
                                    {{selected_item.description}}
                                    {% else %}
                                    {{selected_item.description_ar or selected_item.description}}
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% if recommended_items %}
    <div class="mt-5 md:mt-21">
        <h1 class="text-xl font-bold md:text-3xl">
            {{ _('You might also be interested in') }}
        </h1>
        <div class="mt-9 mb-18 grid grid-cols-1 sm:grid-cols-2 md:mt-11 md:grid-cols-3 md:gap-8 lg:grid-cols-4">
            {% for item in recommended_items %}
            <div class="mb-11 md:mb-4">
                {% set product_name = item.item_name if frappe.lang == "en" else item.custom_item_name_ar or "" %}
                <a href="/{{frappe.lang}}/products/{{item.route}}">
                    {{ item_card(
                    image=item.image or "/assets/ls_shop/images/1.jpg",
                    brand=item.brand,
                    product_name=product_name,
                    original_price=item.default_price,
                    formatted_price=item.sale_price,
                    discount=item.discount_percent,
                    size_variant="large",
                    image_size="w-84 h-110 object-cover md:w-60 md:h-80",
                    product_obj=item,
                    attribute_value=item.attribute_value
                    ) }}
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
{% block script %}
<script>
    // Carousel
    function carousel_component() {
        return {

            images: '{{ images|tojson }}',
            current_index: 0,
            embla: null,

            init_embla() {
                const embla_node = this.$el.querySelector('.carousel_container');
                const viewport_node = embla_node.querySelector('.embla__viewport');
                this.embla = EmblaCarousel(viewport_node, { loop: false });

                this.embla.on('select', () => {
                    this.current_index = this.embla.selectedScrollSnap();
                });

                this.embla.on('reInit', () => {
                    this.current_index = this.embla.selectedScrollSnap();
                });

                const setup_dots = (embla_api, dots_node) => {
                    const slides = embla_api.slideNodes()
                    // Clear existing dots
                    dots_node.innerHTML = ''

                    // Create a button for each slide
                    slides.forEach((_, index) => {
                        let dot_button = document.createElement('button')
                        dot_button.classList.add('embla__dot')
                        dot_button.addEventListener('click', () => embla_api.scrollTo(index))
                        dots_node.appendChild(dot_button)
                    })

                    // Update dots on select
                    const update_dots = () => {
                        const dots = dots_node.querySelectorAll('.embla__dot')
                        const selected_index = embla_api.selectedScrollSnap()

                        dots.forEach((dot, index) => {
                            dot.classList.toggle('embla__dot--selected', index === selected_index)
                        })
                    }
                    // Initial update and add listeners
                    update_dots()
                    embla_api.on('select', update_dots)
                    embla_api.on('reInit', update_dots)
                }

                const dots_node = embla_node.querySelector('.embla__dots');
                    setup_dots(this.embla, dots_node);
                
            },

            previous_image() {
                this.embla.scrollPrev();
                this.current_index = this.embla.selectedScrollSnap();
            },

            next_image() {
                this.embla.scrollNext();
                this.current_index = this.embla.selectedScrollSnap();
            }

        }
    }

</script>
<script>
    // Image zoom
    function debounce(fn, delay) {
        let timer;
        return function (...args) {
            clearTimeout(timer);
            timer = setTimeout(() => fn.apply(this, args), delay);
        };
    }

    document.querySelectorAll('.zoom-container').forEach(container => {
        if (window.innerWidth < 768) {
            return;
        }
        const image = container.querySelector('.zoom-image');

        const handle_mouse_enter = debounce(() => {
            image.style.transform = 'scale(2)';
            image.style.opacity = '0.95';
        }, 100); // Delay zoom-in by 100ms

        const handle_mouse_leave = debounce(() => {
            image.style.transform = 'scale(1)';
            image.style.opacity = '1';
        }, 50); // Delay zoom-out slightly

        const handle_mouse_move = (e) => {
            const rect = container.getBoundingClientRect();
            const offsetX = e.clientX - rect.left;
            const offsetY = e.clientY - rect.top;
            const percentX = (offsetX / rect.width) * 100;
            const percentY = (offsetY / rect.height) * 100;

            image.style.transformOrigin = `${percentX}% ${percentY}%`;
        };

        container.addEventListener('mouseenter', handle_mouse_enter);
        container.addEventListener('mouseleave', handle_mouse_leave);
        container.addEventListener('mousemove', handle_mouse_move);
    });
</script>
<script>
    // State management for product size
    function update_size(size) {
        state.size = `${size}`;
        window.location.reload();
    }
    async function notify_user_product(item) {

            data = await frappe_call("/api/v2/method/ls_shop.api.utils.notify_user_product", { item: item })

            toast("{{_('You will be notified when item is available')}}", { type: "success" })
    }
</script>
{% endblock %}