<div x-data="{
    filters: {{ filters }},
    query_state: window.query_state, // Directly reference QuerySync state
    accordion: null,
    format_key(key) {
        const formatted = key.replace(/([A-Z])/g, ' $1').trim();
        return formatted.charAt(0).toUpperCase() + formatted.slice(1);
    },
    reset_filters() {
        Object.keys(this.query_state).forEach((key) => {
            delete this.query_state[key]; // Removes from state and URL
        });
        window.location.reload()
    },
    toggle_filter(key, value, is_subcategory = false) {
        // Determine the correct query param key
        let query_key = is_subcategory ? 'subcategory' : key;
    
        // Get current selections
        let current_selections = this.query_state[query_key] 
            ? this.query_state[query_key].split(',') 
            : [];
    
        // For subcategories, just use the value directly without adding the key prefix
        let formatted_value = value;
    
        if (current_selections.includes(formatted_value)) {
            // Remove if already selected
            current_selections = current_selections.filter(item => item !== formatted_value);
        } else {
            // Add if not selected
            current_selections.push(formatted_value);
        }
    
        // Update state (store as a comma-separated string)
        this.query_state[query_key] = current_selections.length ? current_selections.join(',') : '';
    
        // Refresh the page
        if(window.innerWidth > 768){
        window.location.reload();
    }
    },
    toggle_price_filter(key,value){
        // Update state (store as a comma-separated string)
        this.query_state[key] = value;
        if(window.innerWidth > 768){
            window.location.reload();
        }
    },
    is_checked(key, value, is_subcategory = false) {
        let query_key = is_subcategory ? 'subcategory' : key;
        return this.query_state[query_key] && this.query_state[query_key].split(',').includes(value);
    },
    apply_filters(){
        window.location.reload()
    }
    }" class="md:h-[70vh] md:overflow-y-auto no-scrollbar">
    <div class="mb-5 hidden items-center justify-between border-b border-gray-300 pb-5 md:flex">
        <h2 class="mb-4 text-lg font-medium capitalize">
            {{_('filter by')}}
        </h2>
        <button class="mb-4 text-lg font-medium text-red-800 hover:text-red-600 cursor-pointer capitalize" @click="reset_filters">
            {{_('reset all')}}
        </button>
    </div>
    <div x-data="{ current_tab: null }">
        <template x-for="(values, key) in filters" :key="key">
            <div class="border-b border-gray-300">
                <button @click="current_tab = (current_tab === key) ? null : key"
                    class="flex w-full items-center justify-between py-4 text-lg font-medium cursor-pointer">
                    <span x-text="$store.i18n.t(format_key(key))"></span>
                    <svg class="w-5 h-5 transition-transform duration-200"
                        :class="{ 'rotate-180': current_tab === key }" xmlns="http://www.w3.org/2000/svg"
                        viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                            clip-rule="evenodd" />
                    </svg>
                </button>
                <!-- Normal Filters (brands, sizes, colors) -->
                <div x-show="current_tab === key && !Array.isArray(values[0]) && key !== 'Men'&& key !== 'Women' && key !== 'Kids'"
                    x-transition class="pt-6 pb-6">
                    <div class="space-y-2">
                        <template x-for="(option, index) in values" :key="index">
                            <div class="flex items-center">
                                <input type="checkbox" :id="`${key}-${option}-${index}`" :value="option"
                                    @change="toggle_filter(key, option, false)"
                                    :checked="is_checked(key, option, false)"
                                    class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                <label :for="`${key}-${option}-${index}`" class="ms-2 text-sm text-gray-700 capitalize"
                                    x-text="$store.i18n.t(option)"></label>
                            </div>
                        </template>
                    </div>
                </div>
                <!-- Nested Categories (Men, Women, Kids) -->

                <template x-for="(category,index) in ['Men','Women','Kids']" :key="index">
                    <div x-show="current_tab === key && !Array.isArray(values[0]) && key === category" x-transition
                        class="pt-6 pb-6">
                        <template x-for="(node, node_index) in values" :key="node_index">
                            <div class="mb-3">
                                <div x-data="{ open: false }">
                                    <!-- Node with children gets an expand/collapse button -->
                                    <div x-show="!node.is_leaf" class="flex items-center">
                                        <span class="flex items-center text-gray-800 font-semibold"
                                            x-text="$store.i18n.t(node.display_name)"></span>

                                    </div>

                                    <!-- Leaf node gets a checkbox -->
                                    <div x-show="node.is_leaf" class="flex items-center">
                                        <input type="checkbox" :id="`${category}-${node_index}`" :value="node.name"
                                            @change="toggle_filter(key, node.name, true)"
                                            :checked="is_checked(key, node.name, true)"
                                            class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                        <label :for="`${category}-${node_index}`" class="ms-2 text-sm text-gray-700 capitalize"
                                            x-text="$store.i18n.t(node.display_name)"></label>
                                    </div>

                                    <!-- Recursively render children -->
                                    <div class="pl-3 mt-2 space-y-2">
                                        <template x-for="(child, child_index) in node.children" :key="child_index">
                                            <div x-data="{ childOpen: false }" class="mb-2">
                                                <!-- Child with its own children -->

                                                <div x-show="!child.is_leaf" class="flex items-center">
                                                    <button @click="childOpen = !childOpen"
                                                        class="flex items-center text-gray-800 font-medium">
                                                     
                                                        <span x-text="$store.i18n.t(child.display_name)"></span>
                                                    </button>
                                                </div>

                                                <!-- Child leaf node -->
                                                <div x-show="child.is_leaf" class="flex items-center">
                                                    <input type="checkbox"
                                                        :id="`${category}-${node_index}-${child_index}`"
                                                        :value="child.name"
                                                        @change="toggle_filter(key, child.name, true)"
                                                        :checked="is_checked(key, child.name, true)"
                                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                                    <label :for="`${category}-${node_index}-${child_index}`"
                                                        class="ms-2 text-sm text-gray-700 capitalize"
                                                        x-text="$store.i18n.t(child.display_name)"></label>
                                                </div>

                                                <!-- Grandchildren (third level) -->
                                                <div class="pl-3 mt-2 space-y-2">
                                                    <template x-for="(grandchild, grandchild_index) in child.children"
                                                        :key="grandchild_index">
                                                        <div class="flex items-center">
                                                            <input type="checkbox"
                                                                :id="`${category}-${node_index}-${child_index}-${grandchild_index}`"
                                                                :value="grandchild.name"
                                                                @change="toggle_filter(key, grandchild.name, true)"
                                                                :checked="is_checked(key, grandchild.name, true)"
                                                                class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" />
                                                            <label
                                                                :for="`${category}-${node_index}-${child_index}-${grandchild_index}`"
                                                                class="ms-2 text-sm text-gray-700 capitalize"
                                                                x-text="$store.i18n.t(grandchild.display_name)"></label>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </template>
        </template>
        <div class="border-b border-gray-300">
            <button @click="current_tab = (current_tab === 'price_range') ? null : 'price_range'"
                class="flex w-full items-center justify-between py-4 text-lg font-medium">
                {{_('Price')}}
                <svg class="w-5 h-5 transition-transform duration-200"
                    :class="{ 'rotate-180': current_tab === 'price_range' }" xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                        clip-rule="evenodd" />
                </svg>
            </button>
            <div x-show="current_tab === 'price_range'" x-transition:enter="transition ease-in-out duration-300"
                x-transition:enter-start="opacity-0 transform -translate-y-4"
                x-transition:enter-end="opacity-100 transform translate-y-0"
                x-transition:leave="transition ease-in-out duration-300"
                x-transition:leave-start="opacity-100 transform translate-y-0"
                x-transition:leave-end="opacity-0 transform -translate-y-4" class="pt-6 pb-6">
                <p class="mb-3 text-sm capitalize">{{_('price range')}}</p>
                <div x-data="{
                    min_price: {{ price_range.min_price }},
                    max_price: {{ price_range.max_price }},
                    min: window.query_state.min ? parseInt(window.query_state.min) : {{ price_range.min_price }},
    max: window.query_state.max ? parseInt(window.query_state.max) : {{ price_range.max_price }},
                    error_min: '',
                    error_max: '',
                    validate_min() {
                        if (this.min < this.min_price) {
                            this.error_min = $store.i18n.t('Min price must be at least')
                            this.error_min += ` ${this.min_price}`;
                            this.min = this.min_price;
                            return;
                        } else if (this.min > this.max) {
                            this.error_min = $store.i18n.t('Min price cannot exceed max price');
                            this.min = this.max;
                            return;
                        } else {
                            this.error_min = '';
                        }
                        toggle_price_filter('min',this.min)

                    },
                    validate_max() {
                        if (this.max > this.max_price) {
                            this.error_max = $store.i18n.t('Max price cannot exceed')
                            this.error_max += ` ${this.max_price}`;
                           
                            this.max = this.max_price;
                            return;
                        } else if (this.max < this.min) {
                            this.error_max = $store.i18n.t('Max price must exceed min price');
                            this.max = this.min;
                            return;
                        } else {
                            this.error_max = '';

                        }
                        toggle_price_filter('max',this.max)

                    }
                }" class="flex w-full items-center justify-between gap-3">
                    <!-- Min Price Input -->
                    <div class="flex flex-1 flex-col ">
                        <input type="number"
                            class="w-full rounded-lg border border-gray-300 p-1.5 ps-4 placeholder-gray-300 focus:ring-2 focus:ring-gray-300 focus:outline-gray-300"
                            placeholder="Min" x-model="min" x-bind:min="min_price" x-bind:max="max_price"
                            @change="validate_min()" />
                        <div class="h-5">
                            <span x-show="error_min" class="text-red-600 text-xs ms-2" x-text="error_min"></span>
                        </div>
                    </div>
                    <!-- Max Price Input -->
                    <div class="flex flex-1 flex-col">
                        <input type="number"
                            class="w-full rounded-lg border border-gray-300 p-1.5 ps-4 placeholder-gray-300 focus:ring-2 focus:ring-gray-300 focus:outline-gray-300"
                            placeholder="Max" x-model="max" x-bind:min="min_price" x-bind:max="max_price"
                            @change="validate_max" />
                        <div class="h-5">
                            <span x-show="error_max" class="text-red-600 text-xs ms-2" x-text="error_max"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-15 flex items-center justify-between gap-3 md:hidden">
            <button @click="reset_filters"
                class="w-full rounded-lg border border-red-800 p-2 px-3 text-lg font-medium text-red-800 hover:bg-red-800 hover:text-white capitalize">
                {{_('reset all')}}
            </button>
            <button
                class="transition-easein w-full rounded-lg border bg-red-800 p-2 px-3 text-lg font-medium text-white duration-300 hover:bg-red-900 capitalize"
                @click="apply_filters">
                {{_('apply filters')}}
            </button>
        </div>
    </div>
    <div class="h-10 hidden md:block"></div>
</div>
<div
    class="hidden md:block pointer-events-none absolute bottom-0 left-0 right-0 h-20 bg-gradient-to-t from-white to-transparent z-10">
</div>